# Caddy reverse proxy configuration for crickzen.com
# This file enables automatic HTTPS via Let's Encrypt.
# Ensure DNS A record for crickzen.com (and optionally www.crickzen.com) points to this server's public IP before starting.

{
  # Global ACME email for Let's Encrypt notifications (updated per user request)
  email akshay.d.waghmare@gmail.com
  # Uncomment to use staging (avoid rate limits while DNS propagates):
  # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
  # debug
}

crickzen.com, www.crickzen.com {
  encode gzip
  
  # WebSocket endpoint - must come before general proxy to take precedence
  @websocket {
    path /api/ws/*
  }
  reverse_proxy @websocket frontend:80 {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
    header_up Upgrade {http.request.header.Upgrade}
    header_up Connection {http.request.header.Connection}
    # Increase timeout for long-lived WebSocket connections
    flush_interval -1
  }
  
  # Serve frontend Angular app proxied from internal container
  reverse_proxy frontend:80 {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
  }

  # Optional: health endpoint
  @health path /health
  respond @health "ok" 200

  # Redirect plain / to index.html is handled by Angular; Caddy just proxies.

  # Security headers
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
    # Updated CSP to allow WebSocket connections (wss: for production, ws: for development)
    Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https:; connect-src 'self' ws: wss: https:;"
  }
}

# Optional: redirect bare HTTP to HTTPS if separate site block needed (Caddy auto-handles HTTPS issuance)
