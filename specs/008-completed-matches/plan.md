# Implementation Plan: Completed Matches Functionality

**Branch**: `008-completed-matches` | **Date**: December 7, 2025 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/008-completed-matches/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

**Primary Requirement**: Enable the existing but non-functional "Completed" tab in the Matches page to display up to 20 recently completed cricket matches by querying the existing LIVE_MATCH table where `isDeleted=true`.

**Technical Approach**: 
- **Backend**: Create new REST API endpoint `GET /api/v1/matches/completed` that queries LIVE_MATCH table filtering by `isDeleted=true`, ordering by `updatedAt DESC`, limiting to 20 results
- **Frontend**: Update MatchesService to fetch completed matches and wire them to the existing Completed tab UI
- **No Schema Changes**: Use existing columns (`isDeleted`, `lastKnownState`, `updatedAt`) - no database migration required
- **Existing Infrastructure**: Leverage existing scraper that already sets `isDeleted=true` when matches complete

## Technical Context

**Language/Version**: 
- Backend: Java 8/11, Spring Boot 2.x
- Frontend: TypeScript 3.2, Angular CLI 6.x/7.x
- Scraper: Python 3.x

**Primary Dependencies**: 
- Backend: Spring Boot Web, Spring Data JPA, H2 Database (embedded), Hibernate
- Frontend: Angular, RxJS, TypeScript, Bootstrap
- Testing: JUnit (backend), Jasmine/Karma (frontend)

**Storage**: 
- H2 Embedded Database (file: `./testdb.mv.db`)
- JDBC URL: `jdbc:h2:file:./testdb`
- JPA mode: `ddl-auto=update`
- Console: Available at `:8099/h2-console`

**Testing**: 
- Backend: JUnit, Spring Boot Test, H2 in-memory for tests
- Frontend: Jasmine, Karma, Angular Testing utilities
- Target: >80% backend coverage, >70% frontend coverage

**Target Platform**: 
- Backend: Linux server / Docker container
- Frontend: Modern browsers (Chrome, Firefox, Safari, Edge), Mobile responsive (320px-2560px)
- Database: Embedded H2 (dev/prod), MySQL alternative available

**Project Type**: Web application (monorepo with frontend + backend + scraper)

**Performance Goals**: 
- API response time: <200ms for completed matches query
- Frontend load time: <2 seconds on mobile 3G
- No impact on existing live match performance

**Constraints**: 
- Zero schema migration (use existing columns only)
- Reuse existing match card component
- Maximum 20 matches returned (via LIMIT clause)
- Maintain existing auto-refresh behavior

**Scale/Scope**: 
- ~20 completed matches stored/returned
- Existing LIVE_MATCH table (unknown row count, but finite)
- Single REST endpoint + frontend service update
- Est. 2-3 files modified (backend), 2-3 files modified (frontend)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Real-Time Data Accuracy
✅ **PASS** - Feature uses existing scraper mechanism (already sets `isDeleted=true`). No changes to scraper timing or data accuracy. Completed matches are historical data, not real-time, so 5-second accuracy requirement doesn't apply.

### Principle II: Monorepo Architecture Standards
✅ **PASS** - Feature maintains service boundaries:
- Backend exposes new REST API endpoint `/api/v1/matches/completed`
- Frontend consumes Backend API only (no direct database access)
- Scraper unchanged (already handles completion detection)
- No cross-service database access

### Principle III: REST API Design Standards
✅ **PASS** - New endpoint follows REST conventions:
- Pattern: `GET /api/v1/matches/completed`
- Plural noun resource (`matches`)
- Versioned (`/v1/`)
- Will return standard JSON response format with `success`, `data`, `error`, `timestamp`
- HTTP 200 for success, 500 for server error, proper error messages
- Authentication via existing JWT mechanism

### Principle IV: Testing Requirements
✅ **PASS** - Testing plan:
- Backend: Unit tests for completed matches query logic, integration test for new API endpoint
- Frontend: Component tests for Completed tab, service tests with mocked HTTP calls
- Target: >80% backend coverage, >70% frontend coverage
- Tests required before merge

### Principle V: Performance Standards for Live Updates
✅ **PASS** - Performance considerations:
- Completed matches API: <200ms response time (simple query with index)
- Frontend: Shares existing caching/refresh mechanism with live matches
- No WebSocket/polling needed (completed matches don't update in real-time)
- Query optimized: Uses existing `idx_is_deleted` index + `LIMIT 20`

### Principle VI: Frontend UI/UX Standards
✅ **PASS** - UI/UX compliance:
- Reuses existing match card component (already accessible, responsive, follows design system)
- Error handling: Shows error message with retry option (not silent failure)
- Loading states: Uses existing skeleton/loading indicators
- Responsive: Existing Completed tab already follows mobile-first design
- Accessibility: Existing components already WCAG 2.1 AA compliant
- No new components needed

**Constitution Compliance**: ✅ **ALL GATES PASS** - Feature fully compliant with all constitution principles.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

## Project Structure

### Documentation (this feature)

```text
specs/008-completed-matches/
├── plan.md              # This file (/speckit.plan command output)
├── spec.md              # Feature specification (already exists)
├── data-model.md        # Phase 1 output (already exists, will update)
├── research.md          # Phase 0 output (will be generated)
├── quickstart.md        # Phase 1 output (will be generated)
├── contracts/           # Phase 1 output (will be generated)
│   └── completed-matches-api.yaml  # OpenAPI spec for new endpoint
├── checklists/          # Already exists
│   └── requirements.md  # Requirements validation checklist
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
apps/
├── backend/
│   └── spring-security-jwt/
│       ├── src/main/java/com/devglan/
│       │   ├── controller/
│       │   │   └── MatchController.java           # ADD: /api/v1/matches/completed endpoint
│       │   ├── service/
│       │   │   └── MatchService.java               # ADD: getCompletedMatches() method
│       │   ├── dao/
│       │   │   └── LiveMatchRepository.java        # ADD: findByIsDeletedTrueOrderByUpdatedAtDesc query
│       │   └── model/
│       │       └── LiveMatch.java                  # EXISTING: No changes needed
│       └── src/test/java/com/devglan/
│           ├── controller/
│           │   └── MatchControllerTest.java        # ADD: Test completed endpoint
│           └── service/
│               └── MatchServiceTest.java           # ADD: Test getCompletedMatches()
│
├── frontend/
│   └── src/app/
│       ├── features/matches/
│       │   ├── pages/matches-list/
│       │   │   ├── matches-list.component.ts       # MODIFY: Wire completed matches to tab
│       │   │   └── matches-list.component.html     # EXISTING: No changes (tab exists)
│       │   └── services/
│       │       └── matches.service.ts              # ADD: getCompletedMatches() method
│       └── shared/models/
│           └── match.model.ts                      # EXISTING: MatchCardViewModel (no changes)
│
└── scraper/
    └── crex_scraper_python/                        # EXISTING: No changes (already sets isDeleted=true)
```

**Structure Decision**: Web application (Option 2) - This is a monorepo with separate backend (Spring Boot) and frontend (Angular) applications that communicate via REST API. The feature requires changes only to backend (new API endpoint) and frontend (service + component updates). No scraper changes needed as it already marks matches complete by setting `isDeleted=true`.

## Complexity Tracking

> **No violations - This section intentionally empty**

All constitution principles pass without violations. No justification required.

---

## Phase 0: Research (COMPLETE)

**Status**: ✅ Complete  
**Output**: [research.md](./research.md)

All technical unknowns were resolved during the specification and clarification phases. Research document consolidates the following decisions:

1. **Database Approach**: Use existing LIVE_MATCH table with `isDeleted=true` filter
2. **Completion Detection**: Leverage existing scraper/background job
3. **20-Match Limit**: API-level LIMIT clause (no cleanup job)
4. **Error Handling**: Show user-friendly retry message
5. **Timestamp Field**: Use existing `updatedAt` column

**Key Findings**:
- No schema migration required (uses only existing columns)
- Spring Boot REST API best practices documented
- Angular service integration patterns documented
- Query optimization strategies identified
- Testing strategies defined for >80% backend, >70% frontend coverage

---

## Phase 1: Design & Contracts (COMPLETE)

**Status**: ✅ Complete  
**Outputs**: 
- [data-model.md](./data-model.md) (already exists, validated)
- [contracts/completed-matches-api.yaml](./contracts/completed-matches-api.yaml) (OpenAPI 3.0 spec)
- [quickstart.md](./quickstart.md) (developer quick reference)
- [.github/copilot-instructions.md](./.github/copilot-instructions.md) (agent context updated)

### Data Model

**Entities Involved**:
- **LiveMatch** (existing): No changes needed
  - `isDeleted` (BOOLEAN) - marks match as completed
  - `lastKnownState` (TEXT) - contains match result
  - `updatedAt` (TIMESTAMP) - used for ordering
  - Existing `getWinningTeam()` method parses winner

**Query Pattern**:
```sql
SELECT * FROM LIVE_MATCH 
WHERE isDeleted = true 
ORDER BY updatedAt DESC 
LIMIT 20
```

**No Schema Changes**: Feature uses only existing columns.

### API Contract

**Endpoint**: `GET /api/v1/matches/completed`

**Request**:
- Method: GET
- Headers: `Authorization: Bearer <JWT>`
- No query parameters or request body

**Response** (200 OK):
```json
{
  "success": true,
  "data": [
    {
      "id": 12345,
      "url": "https://crex.com/matches/ind-vs-aus-2025",
      "isDeleted": true,
      "lastKnownState": "India won by 7 wickets (29 balls remaining)",
      "updatedAt": "2025-12-06T18:30:45.123Z",
      "deletionAttempts": 1,
      "isDistributionDone": true
    }
  ],
  "error": null,
  "timestamp": "2025-12-07T10:30:45.123Z"
}
```

**Error Responses**:
- 401: Unauthorized (JWT missing/invalid)
- 500: Internal Server Error (database failure)

Full OpenAPI specification available in [contracts/completed-matches-api.yaml](./contracts/completed-matches-api.yaml).

### Frontend Integration

**Service Method**:
```typescript
getCompletedMatches(): Observable<Match[]>
```

**Component Behavior**:
- Completed tab click triggers API call
- Loading state: Show existing skeleton/spinner
- Success: Display matches in existing match cards
- Error: Show "Unable to load completed matches. Tap to retry" message
- Tab count badge: Updates with `completedMatches.length`

### Agent Context Update

GitHub Copilot context updated with:
- Backend: Spring Boot REST API patterns
- Frontend: Angular service + component integration
- Database: H2 embedded query patterns
- Testing: JUnit + Jasmine patterns

---

## Phase 2: Task Breakdown

**Status**: ⏳ Pending  
**Command**: `/speckit.tasks` (to be run next)

This phase will break down implementation into concrete, assignable tasks with dependencies and acceptance criteria.

**Expected Task Categories**:
1. Backend Development (API endpoint, service, repository)
2. Backend Testing (unit + integration tests)
3. Frontend Development (service + component updates)
4. Frontend Testing (service + component tests)
5. Documentation Updates
6. Manual QA Testing

---

## Implementation Summary

### Files to Create/Modify

**Backend** (`apps/backend/spring-security-jwt/`):
- ✏️ `src/main/java/com/devglan/controller/MatchController.java` - Add `/completed` endpoint
- ✏️ `src/main/java/com/devglan/service/MatchService.java` - Add `getCompletedMatches()` method
- ✏️ `src/main/java/com/devglan/dao/LiveMatchRepository.java` - Add custom query
- ➕ `src/test/java/com/devglan/controller/MatchControllerTest.java` - New test class
- ➕ `src/test/java/com/devglan/service/MatchServiceTest.java` - New test class

**Frontend** (`apps/frontend/`):
- ✏️ `src/app/features/matches/services/matches.service.ts` - Add `getCompletedMatches()` method
- ✏️ `src/app/features/matches/pages/matches-list/matches-list.component.ts` - Wire API to tab
- ✏️ `src/app/features/matches/pages/matches-list/matches-list.component.html` - Add error state (if needed)
- ➕ `src/app/features/matches/services/matches.service.spec.ts` - Add test cases
- ➕ `src/app/features/matches/pages/matches-list/matches-list.component.spec.ts` - Add test cases

**No changes needed**:
- Scraper (already handles completion detection)
- Database schema (uses existing columns)
- LiveMatch entity (no new fields)
- Match card component (already supports completed status)

### Estimated Effort

- Backend Development: 2-3 hours
- Backend Testing: 1-2 hours
- Frontend Development: 2-3 hours
- Frontend Testing: 1-2 hours
- Manual QA: 1 hour
- **Total**: ~8-12 hours

### Success Criteria

✅ Feature is complete when:
1. Backend API endpoint returns up to 20 completed matches
2. Frontend Completed tab displays matches from API
3. Error handling shows retry message on API failure
4. All tests pass (>80% backend, >70% frontend coverage)
5. Manual QA confirms tab functionality on mobile + desktop
6. Constitution compliance verified (all gates pass)

---

## Next Steps

1. ✅ **Phase 0**: Research complete - All decisions documented
2. ✅ **Phase 1**: Design & contracts complete - API contract, data model, quickstart ready
3. ⏳ **Phase 2**: Run `/speckit.tasks` to generate task breakdown
4. ⏳ **Implementation**: Follow tasks.md checklist
5. ⏳ **Testing**: Run all tests, manual QA
6. ⏳ **Deployment**: Merge to develop, deploy to staging, then production

---

## References

- [Feature Specification](./spec.md)
- [Research Document](./research.md)
- [Data Model](./data-model.md)
- [API Contract](./contracts/completed-matches-api.yaml)
- [Quickstart Guide](./quickstart.md)
- [Constitution](./.specify/memory/constitution.md)
