# Prometheus Alerting Rules for Scraper Resilience

groups:
  - name: scraper_health
    interval: 30s
    rules:
      # Data freshness alert
      - alert: DataStale
        expr: data_staleness_seconds > 300
        for: 2m
        labels:
          severity: warning
          component: scraper
        annotations:
          summary: "Match data is stale for {{ $labels.match_id }}"
          description: "No updates for {{ $value }}s (threshold: 300s)"

      # High error rate
      - alert: HighErrorRate
        expr: rate(scraper_errors_total[5m]) > 0.167
        for: 3m
        labels:
          severity: warning
          component: scraper
        annotations:
          summary: "High error rate for {{ $labels.match_id }}"
          description: "{{ $value }} errors/sec (threshold: 10/min)"

      # Memory pressure
      - alert: HighMemoryUsage
        expr: scraper_memory_bytes / 1073741824 > 1.2
        for: 5m
        labels:
          severity: warning
          component: scraper
        annotations:
          summary: "High memory usage for {{ $labels.match_id }}"
          description: "Memory: {{ $value }}GB (soft limit: 1.5GB)"

      # Critical memory
      - alert: CriticalMemoryUsage
        expr: scraper_memory_bytes / 1073741824 > 1.8
        for: 1m
        labels:
          severity: critical
          component: scraper
        annotations:
          summary: "Critical memory usage for {{ $labels.match_id }}"
          description: "Memory: {{ $value }}GB (hard limit: 2GB)"

      # Scraper down
      - alert: ScraperDown
        expr: up{job="scraper"} == 0
        for: 1m
        labels:
          severity: critical
          component: scraper
        annotations:
          summary: "Scraper service is down"
          description: "Prometheus cannot scrape metrics from scraper"

  - name: backend_health
    interval: 30s
    rules:
      # Backend down
      - alert: BackendDown
        expr: up{job="backend"} == 0
        for: 2m
        labels:
          severity: critical
          component: backend
        annotations:
          summary: "Backend service is down"
          description: "Prometheus cannot scrape metrics from backend"
