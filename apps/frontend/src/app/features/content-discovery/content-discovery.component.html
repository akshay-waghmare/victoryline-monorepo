<div class="discovery-root" role="main" aria-label="Match discovery page">
  <!-- Offline indicator banner -->
  <div 
    *ngIf="!isOnline" 
    class="offline-banner" 
    role="alert"
    aria-live="assertive">
    <svg class="offline-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M9 22V12h6v10" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="3" y1="3" x2="21" y2="21" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>You're offline. Showing cached content.</span>
  </div>

  <!-- Cached data indicator -->
  <div 
    *ngIf="usingCachedData && isOnline" 
    class="cached-banner" 
    role="status"
    aria-live="polite">
    <svg class="cache-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" stroke-width="2"/>
      <polyline points="17 21 17 13 7 13 7 21" stroke-width="2"/>
      <polyline points="7 3 7 8 15 8" stroke-width="2"/>
    </svg>
    <span>Showing cached results from earlier</span>
  </div>

  <div class="discovery-header">
    <h1>Discover Matches</h1>
    <app-search 
      (search)="onSearch($event)"
      (suggestionSelected)="onSuggestionSelected($event)"
    ></app-search>
  </div>

  <div class="filters-row" role="group" aria-label="Match filters">
    <label for="match-type-filter">Match Type:</label>
    <select 
      id="match-type-filter"
      [(ngModel)]="filters.type" 
      (change)="applyFilters()"
      aria-label="Filter matches by type">
      <option value="all">All</option>
      <option value="live">Live</option>
      <option value="upcoming">Upcoming</option>
      <option value="completed">Completed</option>
    </select>
    <button 
      (click)="applyFilters()" 
      class="apply-btn"
      aria-label="Apply selected filters">
      Apply Filters
    </button>
  </div>

  <!-- Recently Viewed Section -->
  <section 
    class="content-section" 
    *ngIf="recentlyViewed.length > 0 || showRecentSection"
    aria-labelledby="recently-viewed-heading">
    <div class="section-header">
      <h2 id="recently-viewed-heading">Recently Viewed</h2>
      <button 
        class="clear-btn" 
        *ngIf="recentlyViewed.length > 0"
        (click)="clearHistory()"
        aria-label="Clear recently viewed matches history">
        Clear
      </button>
    </div>
    
    <!-- Loading state -->
    <ul class="match-list horizontal" *ngIf="loading && recentlyViewed.length === 0">
      <li *ngFor="let i of [1,2,3]">
        <app-match-skeleton [compact]="true"></app-match-skeleton>
      </li>
    </ul>
    
    <!-- Loaded state -->
    <ul 
      class="match-list horizontal" 
      *ngIf="!loading && recentlyViewed.length > 0"
      role="list"
      aria-label="Recently viewed matches"
      tabindex="0">
      <li 
        *ngFor="let m of recentlyViewed; let i = index; trackBy: trackByMatchId" 
        class="match-item compact" 
        (click)="onMatchClick(m, 'recently_viewed', i)"
        (keydown.enter)="onMatchClick(m, 'recently_viewed', i)"
        (keydown.space)="onMatchClick(m, 'recently_viewed', i); $event.preventDefault()"
        role="listitem"
        tabindex="0"
        [attr.aria-label]="m.team1?.name + ' vs ' + m.team2?.name + ', ' + m.displayStatus"
        [@fadeIn]>
        <div class="match-header">
          <span class="status-badge" [style.background-color]="m.statusColor" role="status">{{m.displayStatus}}</span>
        </div>
        <div class="teams-compact">
          <div class="team-name">{{m.team1?.name || 'Team 1'}}</div>
          <div class="vs-small" aria-hidden="true">vs</div>
          <div class="team-name">{{m.team2?.name || 'Team 2'}}</div>
        </div>
      </li>
    </ul>
    
    <!-- Empty state -->
    <app-empty-state
      *ngIf="!loading && recentlyViewed.length === 0"
      type="no-history"
      title="No viewing history yet"
      message="Start exploring matches to see your recently viewed content here">
    </app-empty-state>
  </section>

  <!-- Recommended Section -->
  <section 
    class="content-section" 
    *ngIf="recommended.length > 0 || showRecommendedSection"
    aria-labelledby="recommended-heading">
    <div class="section-header">
      <h2 id="recommended-heading">Recommended for You</h2>
    </div>
    
    <!-- Loading state -->
    <ul class="match-list" *ngIf="loading && recommended.length === 0">
      <li *ngFor="let i of [1,2,3]">
        <app-match-skeleton></app-match-skeleton>
      </li>
    </ul>
    
    <!-- Loaded state -->
    <ul class="match-list" *ngIf="!loading && recommended.length > 0" role="list" aria-label="Recommended matches based on your viewing history">
      <li 
        *ngFor="let m of recommended; let i = index; trackBy: trackByMatchId" 
        class="match-item" 
        [class.live]="m.isLive" 
        (click)="onMatchClick(m, 'recommended', i)"
        (keydown.enter)="onMatchClick(m, 'recommended', i)"
        (keydown.space)="onMatchClick(m, 'recommended', i); $event.preventDefault()"
        role="listitem"
        tabindex="0"
        [attr.aria-label]="m.team1?.name + ' vs ' + m.team2?.name + ', ' + m.displayStatus + ', ' + m.venue"
        [@fadeIn]>
        <div class="match-header">
          <span class="status-badge" [style.background-color]="m.statusColor" role="status">{{m.displayStatus}}</span>
          <span class="venue">{{m.venue}}</span>
        </div>
        <div class="teams">
          <div class="team">
            <span class="team-name">{{m.team1?.name || 'Team 1'}}</span>
            <span class="score" *ngIf="m.team1?.score" aria-label="{{m.team1.name}} score: {{m.team1.score.runs}} for {{m.team1.score.wickets}} in {{m.team1.score.overs}} overs">
              {{m.team1.score.runs}}/{{m.team1.score.wickets}} ({{m.team1.score.overs}})
            </span>
          </div>
          <div class="vs" aria-hidden="true">vs</div>
          <div class="team">
            <span class="team-name">{{m.team2?.name || 'Team 2'}}</span>
            <span class="score" *ngIf="m.team2?.score" aria-label="{{m.team2.name}} score: {{m.team2.score.runs}} for {{m.team2.score.wickets}} in {{m.team2.score.overs}} overs">
              {{m.team2.score.runs}}/{{m.team2.score.wickets}} ({{m.team2.score.overs}})
            </span>
          </div>
        </div>
        <div class="match-footer">
          <span class="time-display">{{m.timeDisplay}}</span>
        </div>
      </li>
    </ul>
    
    <!-- Empty state -->
    <app-empty-state
      *ngIf="!loading && recommended.length === 0"
      type="no-recommendations"
      title="No recommendations yet"
      message="View a few matches to get personalized recommendations">
    </app-empty-state>
  </section>

  <!-- All Matches Section -->
  <section 
    class="content-section"
    aria-labelledby="all-matches-heading">
    <div class="section-header">
      <h2 id="all-matches-heading">All Matches</h2>
    </div>
    
    <div class="results" *ngIf="!loading">
      <!-- Empty state -->
      <app-empty-state
        *ngIf="matches.length === 0"
        type="no-results"
        title="No matches found"
        message="Try adjusting your filters or search query">
      </app-empty-state>
      
      <!-- Virtual scroll for large lists -->
      <cdk-virtual-scroll-viewport 
        *ngIf="matches.length > 0"
        [itemSize]="140" 
        class="match-viewport"
        role="list"
        aria-label="All available matches">
        <ul class="match-list">
          <li 
            *cdkVirtualFor="let m of matches"
            class="match-item" 
            [class.live]="m.isLive" 
            (click)="onMatchClick(m)"
            (keydown.enter)="onMatchClick(m)"
            (keydown.space)="onMatchClick(m); $event.preventDefault()"
            role="listitem"
            tabindex="0"
            [attr.aria-label]="m.team1?.name + ' vs ' + m.team2?.name + ', ' + m.displayStatus + ', ' + m.venue"
            [@fadeIn]>
            <div class="match-header">
              <span class="status-badge" [style.background-color]="m.statusColor" role="status">{{m.displayStatus}}</span>
              <span class="venue">{{m.venue}}</span>
            </div>
            <div class="teams">
              <div class="team">
                <span class="team-name">{{m.team1?.name || 'Team 1'}}</span>
                <span class="score" *ngIf="m.team1?.score" aria-label="{{m.team1.name}} score: {{m.team1.score.runs}} for {{m.team1.score.wickets}} in {{m.team1.score.overs}} overs">
                  {{m.team1.score.runs}}/{{m.team1.score.wickets}} ({{m.team1.score.overs}})
                </span>
              </div>
              <div class="vs" aria-hidden="true">vs</div>
              <div class="team">
                <span class="team-name">{{m.team2?.name || 'Team 2'}}</span>
                <span class="score" *ngIf="m.team2?.score" aria-label="{{m.team2.name}} score: {{m.team2.score.runs}} for {{m.team2.score.wickets}} in {{m.team2.score.overs}} overs">
                  {{m.team2.score.runs}}/{{m.team2.score.wickets}} ({{m.team2.score.overs}})
                </span>
              </div>
            </div>
            <div class="match-footer">
              <span class="time-display">{{m.timeDisplay}}</span>
            </div>
          </li>
        </ul>
      </cdk-virtual-scroll-viewport>
    </div>

    <!-- Loading state -->
    <div *ngIf="loading">
      <ul class="match-list">
        <li *ngFor="let i of [1,2,3,4,5]">
          <app-match-skeleton></app-match-skeleton>
        </li>
      </ul>
    </div>
  </section>
</div>
