
services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: victoryline-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-cricket_db}
      MYSQL_USER: ${MYSQL_USER:-cricket_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-cricket_pass}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - victoryline-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: victoryline-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - victoryline-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Spring Boot Backend
  backend:
    build:
      context: ./apps/backend/spring-security-jwt
      dockerfile: Dockerfile
    container_name: victoryline-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8099}:8099"
    environment:
      # Database Configuration (Using H2 embedded for now)
      SPRING_DATASOURCE_URL: jdbc:h2:file:/app/data/victoryline;DB_CLOSE_ON_EXIT=FALSE
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
      SPRING_DATASOURCE_USERNAME: sa
      SPRING_DATASOURCE_PASSWORD:
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.H2Dialect
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: ${SHOW_SQL:-false}
      SPRING_H2_CONSOLE_ENABLED: true
      SPRING_H2_CONSOLE_PATH: /h2-console
      # Flyway Configuration - Disable validation for H2 compatibility
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: true
      SPRING_FLYWAY_VALIDATE_ON_MIGRATE: false
      # Redis Configuration
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      SPRING_CACHE_TYPE: redis
      # JWT Configuration
      JWT_SECRET: ${JWT_SECRET:-victorylineSecretKey123456789012345678901234567890}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-86400}
    volumes:
      - backend_data:/app/data
    depends_on:
      - redis
    networks:
      - victoryline-network
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8099/actuator/health || [ $$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8099/actuator/health) -eq 401 ]"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Python Scraper
  scraper:
    build:
      context: ./apps/scraper
      dockerfile: Dockerfile
    container_name: victoryline-scraper
    restart: unless-stopped
    ports:
      - "${SCRAPER_PORT:-5000}:5000"
    environment:
      # Backend API Configuration
      TOKEN_URL: http://backend:8099/token/generate-token
      SERVICE_URL: http://backend:8099/cricket-data
      ADD_LIVE_MATCHES_URL: http://backend:8099/cricket-data/add-live-matches
      API_ENDPOINT: http://backend:8099/cricket-data/match-info/save
      API_ENDPOINT_SC4: http://backend:8099/cricket-data/sC4-stats/save
      # Scraper Configuration
      FLASK_ENV: ${FLASK_ENV:-production}
      FLASK_DEBUG: ${FLASK_DEBUG:-0}
    volumes:
      - scraper_data:/app/storage
    depends_on:
      - backend
    networks:
      - victoryline-network
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Angular Frontend
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        NODE_VERSION: ${NODE_VERSION:-16.20.2}
    container_name: victoryline-frontend
    restart: unless-stopped
    # Port only exposed internally within Docker network
    # Caddy will proxy external traffic to this container
    expose:
      - "80"
    environment:
      API_URL: http://backend:8099
    depends_on:
      - backend
      - scraper
    networks:
      - victoryline-network
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    volumes:
      - frontend_html:/usr/share/nginx/html

  # Caddy Reverse Proxy
  caddy:
    image: caddy:2-alpine
    container_name: victoryline-caddy
    restart: unless-stopped
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
    volumes:
      - ./Caddyfile.local:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - backend
    networks:
      - victoryline-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prerender Sidecar (periodic + webhook trigger)
  prerender:
    build:
      context: ./apps/frontend
      dockerfile: ./prerender-sidecar/Dockerfile
    container_name: victoryline-prerender
    restart: unless-stopped
    environment:
      BACKEND_URL: http://backend:8099
      PRERENDER_INTERVAL_MINUTES: ${PRERENDER_INTERVAL_MINUTES:-3}
      PRERENDER_OUT_DIR: /shared-html/prerender
    depends_on:
      - backend
      - frontend
    networks:
      - victoryline-network
    volumes:
      - frontend_html:/shared-html
    ports:
      - "${PRERENDER_PORT:-9100}:9100"

networks:
  victoryline-network:
    driver: bridge
    name: victoryline-network

volumes:
  mysql_data:
    driver: local
    name: victoryline-mysql-data
  redis_data:
    driver: local
    name: victoryline-redis-data
  backend_data:
    driver: local
    name: victoryline-backend-data
  scraper_data:
    driver: local
    name: victoryline-scraper-data
  frontend_html:
    driver: local
    name: victoryline-frontend-html
  caddy_data:
    driver: local
    name: victoryline-caddy-data
  caddy_config:
    driver: local
    name: victoryline-caddy-config
