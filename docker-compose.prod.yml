version: "3.8"

services:
  mysql:
    image: "${MYSQL_IMAGE:-mysql:8.0}"
    container_name: victoryline-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD is required}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-cricket_db}"
      MYSQL_USER: "${MYSQL_USER:-cricket_user}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:?MYSQL_PASSWORD is required}"
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - victoryline-network
    healthcheck:
      test:
        - CMD
        - mysqladmin
        - ping
        - -h
        - localhost
        - -u
        - root
        - "-p${MYSQL_ROOT_PASSWORD}"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  backend:
    image: "${BACKEND_IMAGE:-macubex/victoryline-backend:prod}"
    container_name: victoryline-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8099}:8099"
    environment:
      SPRING_PROFILES_ACTIVE: "${SPRING_PROFILES_ACTIVE:-prod}"
      SPRING_DATASOURCE_URL: "${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/cricket_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC}"
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: "${SPRING_DATASOURCE_DRIVER_CLASS_NAME:-com.mysql.cj.jdbc.Driver}"
      SPRING_DATASOURCE_USERNAME: "${SPRING_DATASOURCE_USERNAME:-cricket_user}"
      SPRING_DATASOURCE_PASSWORD: "${SPRING_DATASOURCE_PASSWORD:-cricket_pass}"
      SPRING_JPA_DATABASE_PLATFORM: "${SPRING_JPA_DATABASE_PLATFORM:-org.hibernate.dialect.MySQL8Dialect}"
      SPRING_JPA_HIBERNATE_DDL_AUTO: "${SPRING_JPA_HIBERNATE_DDL_AUTO:-update}"
      SPRING_JPA_SHOW_SQL: "${SHOW_SQL:-false}"
      SPRING_DATASOURCE_INITIALIZATION_MODE: "${SPRING_DATASOURCE_INITIALIZATION_MODE:-always}"
      SPRING_DATASOURCE_DATA: "${SPRING_DATASOURCE_DATA:-classpath:import_users.sql}"
      JWT_SECRET: "${JWT_SECRET:-change_me}"
      JWT_EXPIRATION: "${JWT_EXPIRATION:-86400}"
    volumes:
      - backend_data:/app/data
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - victoryline-network
    healthcheck:
      test:
        - CMD-SHELL
        - >
          curl -fsS http://localhost:8099/actuator/health ||
          [ $(curl -s -o /dev/null -w '%{http_code}' http://localhost:8099/actuator/health) -eq 401 ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  scraper:
    image: "${SCRAPER_IMAGE:-macubex/victoryline-scraper:prod}"
    container_name: victoryline-scraper
    restart: unless-stopped
    ports:
      - "${SCRAPER_PORT:-5000}:5000"
    environment:
      TOKEN_URL: "${TOKEN_URL:-http://backend:8099/token/generate-token}"
      SERVICE_URL: "${SERVICE_URL:-http://backend:8099/cricket-data}"
      ADD_LIVE_MATCHES_URL: "${ADD_LIVE_MATCHES_URL:-http://backend:8099/cricket-data/add-live-matches}"
      API_ENDPOINT: "${API_ENDPOINT:-http://backend:8099/cricket-data/match-info/save}"
      API_ENDPOINT_SC4: "${API_ENDPOINT_SC4:-http://backend:8099/cricket-data/sC4-stats/save}"
      FLASK_ENV: "${FLASK_ENV:-production}"
      FLASK_DEBUG: "${FLASK_DEBUG:-0}"
      PLAYWRIGHT_HEADLESS: "${PLAYWRIGHT_HEADLESS:-true}"
    volumes:
      - scraper_data:/app/storage
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - victoryline-network
    healthcheck:
      test:
        - CMD-SHELL
        - "curl -fsS http://localhost:5000/health || exit 1"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  frontend:
    image: "${FRONTEND_IMAGE:-macubex/victoryline-frontend:prod}"
    container_name: victoryline-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      API_URL: "${API_URL:-http://backend:8099}"
    depends_on:
      backend:
        condition: service_healthy
      scraper:
        condition: service_started
    networks:
      - victoryline-network
    healthcheck:
      test:
        - CMD-SHELL
        - "curl -fsS http://localhost:80 || exit 1"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  victoryline-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  backend_data:
    driver: local
  scraper_data:
    driver: local
